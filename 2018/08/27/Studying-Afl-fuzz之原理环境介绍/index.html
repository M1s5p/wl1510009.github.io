<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="M1s5p" />



<meta name="description" content="AFL(American Fuzzy Lop)">
<meta property="og:type" content="article">
<meta property="og:title" content="Studying-Afl-fuzz之原理环境介绍">
<meta property="og:url" content="http://xq.dropsec.xyz/2018/08/27/Studying-Afl-fuzz之原理环境介绍/index.html">
<meta property="og:site_name" content="M1s5p">
<meta property="og:description" content="AFL(American Fuzzy Lop)">
<meta property="og:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuo6lzw5dvj30hu05rdfy.jpg">
<meta property="og:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuo6t3mao4j30ji076gpe.jpg">
<meta property="og:image" content="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuo6t3iz8qj30ct09njtq.jpg">
<meta property="og:image" content="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuo9srhw7yj30k70590va.jpg">
<meta property="og:image" content="http://wx1.sinaimg.cn/mw690/0060lm7Tly1fuoavgp5dfj30hi06gdhj.jpg">
<meta property="og:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuodmm4s5kj30k90crag3.jpg">
<meta property="og:image" content="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuoekimacbj30gn05p0uk.jpg">
<meta property="og:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuoepj95gbj30620aogmn.jpg">
<meta property="og:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fupewv9ux4j30k208dgnx.jpg">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/tmin.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/analyze_font.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/analyze_result.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/plot_create_pic.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/plot_ls.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/plot_pic.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/afl-whatsup.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/showmap.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/gotcpu.png">
<meta property="og:image" content="http://otc7tld02.bkt.clouddn.com/havecpu.png">
<meta property="og:updated_time" content="2018-09-05T06:43:48.649Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Studying-Afl-fuzz之原理环境介绍">
<meta name="twitter:description" content="AFL(American Fuzzy Lop)">
<meta name="twitter:image" content="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuo6lzw5dvj30hu05rdfy.jpg">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="M1s5p" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/111.jpg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Studying-Afl-fuzz之原理环境介绍 | M1s5p</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/111.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">M1s5p</a></h1>
        </hgroup>

        
        <p class="header-subtitle">No Pain No Gain!</p>
        
		
        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=282324364@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/p/1005055747318462/home?from=page_100505&mod=TAB#place" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/wl1510009" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angr/">Angr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PE结构/">PE结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fuzz/">fuzz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/search/">search</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stack/">stack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/堆栈及汇编基础/">堆栈及汇编基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/寄存器-debug/">寄存器 debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编基础/">汇编基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://spd.dropsec.xyz/">All Right</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://yunnigu.dropsec.xyz/">YunGong</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.dropsec.xyz/">Drops</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://isron.cn/">Isron</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://whc.dropsec.xyz/">Haigo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://yaocl.cn/">Mr_Yao</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">没有可不可以，只有敢不敢做！</div>
                </section>
                
            </div>
        </div>
		<object type="application/x-shockwave-flash" 
		style="outline:none;" 
		data="http://cdn.abowman.com/widgets/hamster/hamster.swf?" 
		width="250" height="150">
		<param name="movie" 
		value="http://cdn.abowman.com/widgets/hamster/hamster.swf?">
		</param><param name="AllowScriptAccess" value="always">
		</param><param name="wmode" value="opaque">
		</param>
		</object>
    </header>
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">M1s5p</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/111.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">M1s5p</a></h1>
            </hgroup>
            
            <p class="header-subtitle">No Pain No Gain!</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=282324364@qq.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/p/1005055747318462/home?from=page_100505&mod=TAB#place" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/wl1510009" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-Studying-Afl-fuzz之原理环境介绍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/08/27/Studying-Afl-fuzz之原理环境介绍/" class="article-date">
      <time datetime="2018-08-27T03:29:59.000Z" itemprop="datePublished">2018-08-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Studying-Afl-fuzz之原理环境介绍
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/binary/">binary</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fuzz/">fuzz</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>AFL(American Fuzzy Lop)<br><a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章对AFL的安装、使用做了介绍，同时使用软件FFmpeg作为fuzz目标介绍了在使用AFL过程中需要注意的一些点，例如ASAN的开启，软件的编译等。参考各位的文章自行学习，如有错误，请各位纠正。</p>
<p>使用工具：<br>环境：64位 Ubuntu 16.04<br>GCC: version 5.4.0<br>AFL：version 2.52<br>FFmpeg: version 4.0.2</p>
<p>参考：<br><a href="http://lcamtuf.coredump.cx/afl/README.txt" target="_blank" rel="external">http://lcamtuf.coredump.cx/afl/README.txt</a><br><a href="http://www.xue63.com/toutiaojy/20180103G0IUER00.html" target="_blank" rel="external">http://www.xue63.com/toutiaojy/20180103G0IUER00.html</a><br><a href="http://www.cnblogs.com/WangAoBo/p/8280352.html" target="_blank" rel="external">http://www.cnblogs.com/WangAoBo/p/8280352.html</a></p>
<p>Fuzzing技术是当前最为强大而有效的漏洞挖掘技术，大多的远程代码执行以及权限提升等较为严重的漏洞都是通过Fuzzing而产出的。但是Fuzzing技术目前依旧存在着限制，许多的代码漏洞都需要更大的路劲覆盖率才可能触发，并非简单的随机尝试就能够得到的。</p>
<p>有方法，必须能执行，AFL(American Fuzzy Lop)被称为目前最高级的Fuzzing测试工具之一，他是由Google的Michał Zalewski开发的一款开源工具。可以有效地对二进制程序进行fuzz，开启相应功能可更深入的根据需求挖掘相关漏洞，如栈溢出、堆溢出、UAF等。</p>
<p>AFL有两种fuzz途径：</p>
<ol>
<li>开源软件：AFL软件进行编译的同时进行插桩，以方便fuzz</li>
<li>闭源软件：配合QEMU直接对闭源的二进制代码进行fuzz</li>
</ol>
<p>无可厚非的是利用插桩技术对软件fuzz的执行效率肯定是高于闭源项目的。</p>
<p>这里简要先介绍一下插桩。<br>插桩：在AFL编译文件时候afl-gcc会在规定位置插入桩代码，可以理解为一个个的小断点(但是没有暂停功能)，在后续fuzz的过程中会根据这些桩代码进行路径探索，测试等。使得测试覆盖面更广，更全面。</p>
<p>另外，在每个分支插入桩代码的同时，afl-as会生成一个随机数作为标识这个代码块的key，运行时便可以利用这些生成的随机数来识别相应代码块。</p>
<h2 id="0x00-AFL简介与安装"><a href="#0x00-AFL简介与安装" class="headerlink" title="0x00 AFL简介与安装"></a>0x00 AFL简介与安装</h2><h3 id="AFL简介"><a href="#AFL简介" class="headerlink" title="AFL简介"></a>AFL简介</h3><p>AFL的本质已经在上面提及，这里说说构造：<br>AFL主要是由三部分组成：</p>
<ol>
<li><p>编译器wrapper：他的功能在于对目标软件（开源）进行编译，编译过程中插入一些AFL识别的函数用以识别探索路径，众所周知的linux下的C/C++编译工具gcc/g++，afl的编译工具为afl-gcc/afl-g++,afl-clang等。具体编译操作后续会有介绍。</p>
</li>
<li><p>测试器fuzzer：afl-fuzz，就是AFL重要的主体，用以对软件进行fuzzing。</p>
</li>
<li><p>其他工具：如afl-cmin,afl-tmin等，一个成功的C位都必须多个辅助才行，这些工具都是为提升测试的效率和成功率而服务的。</p>
</li>
</ol>
<h3 id="AFL安装"><a href="#AFL安装" class="headerlink" title="AFL安装"></a>AFL安装</h3><p>这里直接给出<a href="http://lcamtuf.coredump.cx/afl/" target="_blank" rel="external">AFL-fuzz的官网</a></p>
<p><strong>注意</strong>：我们使用的环境是64位Ubuntu 16.04，确保依赖的llvm，clang都已经正常安装，指令如下：</p>
<pre><code>sudo apt-get install clang
sudo apt-get install llvm
</code></pre><p>找到如图所示位置，点击下载最新版本的安装包（当前最新是2.52版本）。</p>
<p><img src="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuo6lzw5dvj30hu05rdfy.jpg" alt=""></p>
<pre><code>wget http://lcamtuf.coredump.cx/afl/releases/afl-2.52b.tgz
</code></pre><p>安装包下载完成后进行解压，依次执行下述命令：</p>
<pre><code>tar -zxvf afl-2.52b.tgz
cd afl-2.52b
make
sudo make install
</code></pre><p>在编译安装过程中无报错信息，即为安装成功，可直接用afl-fuzz进行调用：</p>
<p><img src="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuo6t3mao4j30ji076gpe.jpg" alt=""><br><img src="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuo6t3iz8qj30ct09njtq.jpg" alt=""></p>
<h2 id="0x01-FFmpeg简介与安装"><a href="#0x01-FFmpeg简介与安装" class="headerlink" title="0x01 FFmpeg简介与安装"></a>0x01 FFmpeg简介与安装</h2><p>俗话说，没有绿叶承托，怎显花朵美丽——沃兹基硕德</p>
<p>正如AFL的强大若是无软件测试，功能无处施展，那最高级测试工具的称号又从何而来？</p>
<h3 id="FFmpeg简介"><a href="#FFmpeg简介" class="headerlink" title="FFmpeg简介"></a>FFmpeg简介</h3><p>这里先用FFmpeg作为编译的例子来介绍一下如何为afl-fuzz做好准备(此例用以介绍开源程序的fuzz)，它是一个很强大的音频处理工具，同样附上<a href="http://ffmpeg.org/" target="_blank" rel="external">FFmpeg官网</a>，是一个完整的、跨平台的解决方案，可以记录、转换和传输音频和视频。</p>
<h3 id="FFmpeg安装"><a href="#FFmpeg安装" class="headerlink" title="FFmpeg安装"></a>FFmpeg安装</h3><p>官网的download目录下即可点击下载或者指令下载：</p>
<pre><code>wget https://ffmpeg.org/releases/ffmpeg-4.0.2.tar.bz2
</code></pre><p>我们创建一个afl-fuzz文件夹用于存放这些绿叶，然后将安装包进行解压，编译安装三部曲，如若我们下载FFmpeg只是让他施展才能的直接使用如下命令</p>
<pre><code>tar -jxvf ffmpeg-4.0.2.tar.bz2
cd ffmpeg-4.0.2/
./configure
make
make install
</code></pre><p>但是，在这里，我们只是为了对它进行测试，尝试去探索漏洞，如果我们使用Q模式进行测试，那么可以直接使用上述的安装命令，但倘若我们使用的是插桩技术的话，这里我们的编译过程就有所不同。</p>
<p>我们希望把编译好的文件生成到指定目录，可以在配置的时候进行指定，(不建议使用–disable-x86asm参数)命令如下：</p>
<pre><code>./configure --prefix =（目录地址)
</code></pre><p><strong>注意</strong>：在配置的是可能会出现如图的错误，很好解决，只需要安装或者跟新对应的nasm/yasm即可。</p>
<pre><code>sudo apt-get install nasm/yasm
</code></pre><p><img src="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuo9srhw7yj30k70590va.jpg" alt=""></p>
<p>另外，这里的目标是一个图片、视频处理软件，如果我们的fuzz的对象是一个库文件的话，一般在配置执行的时候加上<strong>–disable-shared</strong>选项，这是用来告诉编译器，我们想编译得到的是静态库(在最后调用库函数的时候，不需要再去考虑解析的问题了)，而非是动态链接库</p>
<p>配置执行完后可有两种方法用指定的afl-gcc/afl-g++进行编译</p>
<ol>
<li><p>设置环境变量（适用于基于环境的库文件编译）：顾名思义，我们可以将CC与CXX（分别对应C于C++）设置环境变量指定为afl-gcc与afl-g++，然后make进行编译。</p>
<p>export CC=afl-gcc<br>export CXX=afl-g++</p>
</li>
<li><p>设置mak文件（适用于所有的看开源软件目标）:在配置跑完后，会在ffbulid下生成一个config.mak的文件，我们需要做的就是把里面CC以及CXX复制的gcc和g++全部改为afl-gcc和afl-g++后进行make编译即可。</p>
</li>
</ol>
<p><img src="http://wx1.sinaimg.cn/mw690/0060lm7Tly1fuoavgp5dfj30hi06gdhj.jpg" alt=""></p>
<p>如上图所示，当出现了afl-gcc以及afl-as的标志，表示成功使用afl进行编译</p>
<p><strong>注</strong>：在make命令执行的时候，我们可以设置AFL_HARDEN=1，可以促使CC自动化代码加固，试得检测简单的内存bug更加容易。Libdislocator是AFL提供的一个辅助库，能帮助发现堆崩溃问题。</p>
<p>由于这里是对软件进行fuzzing，所以这里就不必继续执行make install了，使用命令行调用相关位置的ffmpeg工具即可，如图所示：</p>
<p><img src="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuodmm4s5kj30k90crag3.jpg" alt=""></p>
<h2 id="0x02-ASAN"><a href="#0x02-ASAN" class="headerlink" title="0x02 ASAN"></a>0x02 ASAN</h2><h3 id="ASAN简介"><a href="#ASAN简介" class="headerlink" title="ASAN简介"></a>ASAN简介</h3><p>ASAN(Address Sanitizer)是linux下的内存检测工具，早先是LLVM中的特性，后来被加入GCC 4.9，现被clang和gcc支持，用于运行的时候对内存进行检测，以达到发现内存漏洞的效果。</p>
<p>在开启ASAN后。afl插桩则会在目标代码的关键位置添加检查代码，例如：malloc(),free()等，一旦发现了内存访问错误，便可以SIGABRT中止程序。</p>
<p><strong>注意</strong>：</p>
<ol>
<li><p>例如越界读等内存访问错误不一定会造成程序的崩溃，所以在没有开启ASAN的情况下，许多内存漏洞都无法被AFL给发现。所以在编译二进制代码的时候，强烈建议开启ASAN。</p>
</li>
<li><p>ASAN开启后的fuzzing会消耗更多的内存，这是需要注意的因素，对于32位的程序，基本上800MB即可；但64为程序大概需要20TB,所以，使用ASAN的话，建议添加CFLAGS=-m32来限制编译目标为32位，否则，可能应为64位消耗内存过多而造成程序崩溃。</p>
</li>
<li><p>在使用了ASAN之后，可以再alf-fuzz的时候通过选项-m来指定使用的内存上限。启用了ASAN的32位程序，一般设置-m 1024即可。</p>
</li>
</ol>
<h3 id="ASAN的使用"><a href="#ASAN的使用" class="headerlink" title="ASAN的使用"></a>ASAN的使用</h3><ol>
<li><p>ASAN是GCC支持的一个性能，所以，在使用ALF对软件进行编译之前，只需要设置环境变量即可，指令如下：</p>
<pre><code>export AFL_USE_ASAN=1 
</code></pre></li>
<li><p>ASAN的开启，如果是针对小程序的话，只需要在编译的同时，加上选项–fsanitizer=address即可。</p>
</li>
</ol>
<p>编译过程中，见到图中的ASAN mode的标志就说明成功开启了ASAN进行编译。</p>
<p><img src="http://wx4.sinaimg.cn/mw690/0060lm7Tly1fuoekimacbj30gn05p0uk.jpg" alt=""></p>
<p>编译结束之后，为了保证我们的软件成功的开启了ASAN并且在目标代码的关键位置插入了检查代码，我们还需要用命令进行检测，命令如下:</p>
<pre><code>strings ffmpeg |grep &apos;asan&apos;
</code></pre><p>若已经成功的开启ASAN编译了目标软件，则会看到如图结果：</p>
<center><img src="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fuoepj95gbj30620aogmn.jpg" alt=""></center>


<h2 id="0x03-Other-tools"><a href="#0x03-Other-tools" class="headerlink" title="0x03 Other tools"></a>0x03 Other tools</h2><p>前面已经介绍了AFL的编译wrapper，在对一个对象进行测试之前这一步是必须的（别抬杠，我知道除了Q它），这里介绍一下AFL的一些辅助工具，利用这些工具可以使得测试任务事半功倍。</p>
<h3 id="afl-cmin"><a href="#afl-cmin" class="headerlink" title="afl-cmin"></a>afl-cmin</h3><p>如果说AFL是一把狙击枪（管他AWM还是巴雷特），那么afl-cmin可以比作是红外瞄准器。<br>afl-cmin的工作需要给定一个包含有可能的(两个以上)testcases的<strong>文件夹</strong>，他会运行每一个收到的反馈与其他所有的testcases进行对比，以找到最具有代表性的testcase，将其保存到新的目录。在进行测试的时候可以直接使用这个新的testcase，可以使得测试效率提升不少。</p>
<p>使用FFmpeg的testcase为例，输入如下命令运行afl-cmin(有关参数会具体讲述)：</p>
<pre><code>afl-cmin -m none -i afl_in/ -o input_after_cmin/ -- ../ffmpeg-4.0.2/ffmpeg -i @@
</code></pre><p>稍等读条结束便会在指定的目录下生成新的文件，如图所示：</p>
<p><img src="http://wx3.sinaimg.cn/mw690/0060lm7Tly1fupewv9ux4j30k208dgnx.jpg" alt=""></p>
<h3 id="afl-tmin"><a href="#afl-tmin" class="headerlink" title="afl-tmin"></a>afl-tmin</h3><p>众所周知，红外瞄准器可辅助狙击枪达成目的，但是要是有了倍镜就能更为有效的完成目标。afl-tmin便是AFL的倍镜。</p>
<p>afl-tmin的工作对象是一个指定<strong>文件</strong>，当我们进行fuzz的时候，谁都不希望浪费任何一颗子弹，浪费CPU去处理相对testcase表示代码路径无用的bit或者byte是没有任何意义的。afl-tmin会遍历tesecase的真实字节，逐步地删除很小的数据块，直到删除任意字节都会影响到代码路径表示。这样一来，AFL便可以直击要害，高效而有精确的get crashes。</p>
<p>这里我们可以对testcase进行处理，当然也可以对经过cmin处理后的文件进行处理，但必须对输入进行指定文件，输入如下命令运行afl-tmin(有关参数会具体讲述)：</p>
<pre><code>afl-tmin -m none -i input_after_cmin/hh3.mp4 -o input_after_tmin/hh.mp4 -- ../ffmpeg-4.0.2/ffmpeg -i @@
</code></pre><p>稍等读条结束便会在指定的目录下生成新的文件，如图所示，从图中便可以看出tmin以及把testcase删减了很多无用的块和路径。</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/tmin.png" width="500" height="600" align="center"></p>
<h3 id="afl-analyze"><a href="#afl-analyze" class="headerlink" title="afl-analyze"></a>afl-analyze</h3><p>这个工具也是AFL下的一个分析工具，他需要一个输入文件，我们既然对一个软件进行测试，那么输入的文件使用tesecase即可，然后afl-analyze会尝试着去翻转这个文件的字节，输入到目标软件观察其行为，之后会根据tesecase的代码的关键性进行字节的编码着色。能够深入的探索并了解复杂的文件结构。</p>
<p>还是以FFmpeg为例，我们输入如下指令便可以看到afl-analyze的代码颜色分类(有关参数会具体讲述)：</p>
<pre><code>afl-analyze -m none -i afl_in/hh.mp4 -- ../ffmpeg-4.0.2/ffmpeg -i @@
</code></pre><p><img src="http://otc7tld02.bkt.clouddn.com/analyze_font.png" alt=""></p>
<p>然后就是静候，运行时间其实取决于testcase的大小，建议30K以内(若testcase太大，那么执行afl-analyze包括后面要说的afl-fuzz都是一个很大的负担)，最终分析结果如图所示(截取其中一部分展示)。</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/analyze_result.png" alt=""></p>
<h3 id="afl-plot"><a href="#afl-plot" class="headerlink" title="afl-plot"></a>afl-plot</h3><p>这是一个纯辅助工具，作用在于将一个正在fuzz的输出目录或者已经fuzz完成的输出目录进行分析，利用生成的plot数据自动生成数据图片让fuzzer更方便的分析了解。在输出目录中会生成一个index.html以及三个png格式图片，可以使用浏览器查看，但是需要实现安装gnuplot才可以。</p>
<p>使用如下命令即可安装gnuplot:</p>
<pre><code>sudo apt-get install gnuplot
</code></pre><p>然后在terminal中输入：</p>
<pre><code>gnuplot
</code></pre><p>若出现Terminal type set to unknown.那么还需要再安装x11：</p>
<pre><code>sudo apt-get install gnuplot-x11
</code></pre><p>至此就已经完成gnuplot的安装并可以使用。</p>
<p>下面便可以使用afl-plot生成图片，格式如下：</p>
<pre><code>sudo afl-plot afl_state_dir graph_output_dir
</code></pre><p>这里用选项M下生成信息作为例子，如图输入指令后便可以生成图片并保存在指定的文件夹：</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/plot_create_pic.png" alt=""></p>
<p>可以看到如介绍所言，生成了index.html和三个picture。</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/plot_ls.png" alt=""></p>
<p>我们使用下述指令便可以访问查看生成的图了：</p>
<pre><code>firefox index.html
</code></pre><p><img src="http://otc7tld02.bkt.clouddn.com/plot_pic.png" alt=""></p>
<h3 id="afl-whatsup"><a href="#afl-whatsup" class="headerlink" title="afl-whatsup"></a>afl-whatsup</h3><p>这个工具是在afl的输出目录下进行检查，对afl测试过程中或者结束后的输出结果进行统计(fuzz时间，文件大小，crash个数等。)如果加上选项-s则只检查当前目录，不会遍历统计，显示总体的统计结果。指令如下：</p>
<pre><code>afl-whatsup [-s] afl_sync_dir
</code></pre><p>结果如图(还在fuzz的目录)：</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/afl-whatsup.png" width="550" height="400" align="center"></p>
<h3 id="afl-showmap"><a href="#afl-showmap" class="headerlink" title="afl-showmap"></a>afl-showmap</h3><p>这个工具是用来跟踪目标软件(这里是FFmpeg)在有输入时的运行、映射关系，并用-o参数指定输出。<br>指令如下(有关参数会具体讲述)：</p>
<pre><code>afl-showmap -m none -o afl_map/showmap.txt ../ffmpeg-4.0.2/ffmpeg -i input_after_tmin/hh.mp4
</code></pre><p><img src="http://otc7tld02.bkt.clouddn.com/showmap.png" alt=""></p>
<p>运行结束则会在指定目录下生成跟踪数据(数据太大就不进行展示了)</p>
<h3 id="afl-gotcpu"><a href="#afl-gotcpu" class="headerlink" title="afl-gotcpu"></a>afl-gotcpu</h3><p>顾名思义，这个工具就是用以获取CPU的使用率，如图所示，正在执行两个fuzz，cpu以及超负荷显示红色(电脑性能不好，难受)。</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/gotcpu.png" alt=""></p>
<p>换一台高性能些的电脑吧。这样就能看到还有多少资源可以被使用，多少的资源正在运行。如图所示：</p>
<p><img src="http://otc7tld02.bkt.clouddn.com/havecpu.png" alt=""></p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>至此,已经对AFL的安装、功能做了基本介绍，另外以FFmpeg为例，对fuzz之前的准备工作做了详细介绍，除此以外，还把AFL的各个辅助工具做了介绍，后面会继续以FFmpeg作为对象，具体介绍fuzz的过程。包括之前提及的参数问题、分析问题等。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/08/27/Studying-Afl-fuzz之原理环境介绍/">Studying-Afl-fuzz之原理环境介绍</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">M1s5p</a></p>
        <p><span>发布时间:</span>2018-08-27, 11:29:59</p>
        <p><span>最后更新:</span>2018-09-05, 14:43:48</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/08/27/Studying-Afl-fuzz之原理环境介绍/" title="Studying-Afl-fuzz之原理环境介绍">http://xq.dropsec.xyz/2018/08/27/Studying-Afl-fuzz之原理环境介绍/</a>
            <span class="copy-path" data-clipboard-text="原文: http://xq.dropsec.xyz/2018/08/27/Studying-Afl-fuzz之原理环境介绍/　　作者: M1s5p" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/08/29/Using-Afl-fuzz之一/">
                    Using-Afl-fuzz之一
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/05/30/gdb-attach跟exp/">
                    gdb.attach跟exp
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-AFL简介与安装"><span class="toc-number">2.</span> <span class="toc-text">0x00 AFL简介与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AFL简介"><span class="toc-number">2.1.</span> <span class="toc-text">AFL简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AFL安装"><span class="toc-number">2.2.</span> <span class="toc-text">AFL安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-FFmpeg简介与安装"><span class="toc-number">3.</span> <span class="toc-text">0x01 FFmpeg简介与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FFmpeg简介"><span class="toc-number">3.1.</span> <span class="toc-text">FFmpeg简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FFmpeg安装"><span class="toc-number">3.2.</span> <span class="toc-text">FFmpeg安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-ASAN"><span class="toc-number">4.</span> <span class="toc-text">0x02 ASAN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ASAN简介"><span class="toc-number">4.1.</span> <span class="toc-text">ASAN简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASAN的使用"><span class="toc-number">4.2.</span> <span class="toc-text">ASAN的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-Other-tools"><span class="toc-number">5.</span> <span class="toc-text">0x03 Other tools</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-cmin"><span class="toc-number">5.1.</span> <span class="toc-text">afl-cmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-tmin"><span class="toc-number">5.2.</span> <span class="toc-text">afl-tmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-analyze"><span class="toc-number">5.3.</span> <span class="toc-text">afl-analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-plot"><span class="toc-number">5.4.</span> <span class="toc-text">afl-plot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-whatsup"><span class="toc-number">5.5.</span> <span class="toc-text">afl-whatsup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-showmap"><span class="toc-number">5.6.</span> <span class="toc-text">afl-showmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#afl-gotcpu"><span class="toc-number">5.7.</span> <span class="toc-text">afl-gotcpu</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-总结"><span class="toc-number">6.</span> <span class="toc-text">0x04 总结</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/08/29/Using-Afl-fuzz之一/" title="上一篇: Using-Afl-fuzz之一">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/05/30/gdb-attach跟exp/" title="下一篇: gdb.attach跟exp">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/Angr学习记录/">Angr学习记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/10/Studying-Afl-fuzz之内部实现介绍/">Studying-Afl-fuzz之内部实现介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/31/Studying-Afl-fuzz之文件处理介绍/">Studying-Afl-fuzz之文件处理介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/30/Using-Afl-fuzz之二/">Using-Afl-fuzz之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/29/Using-Afl-fuzz之一/">Using-Afl-fuzz之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/27/Studying-Afl-fuzz之原理环境介绍/">Studying-Afl-fuzz之原理环境介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/30/gdb-attach跟exp/">gdb.attach跟exp</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/校赛Reverse-Crypto-writeup/">校赛Reverse&Crypto writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/缓冲区溢出-栈溢出/">缓冲区溢出--栈溢出</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/10/XMAN排位赛-babymaze/">XMAN排位赛-babymaze</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/21/小论PE结构/">小论PE结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/汇编子程序/">汇编子程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/19/XMAN练习writeup及所得/">XMAN练习 writeup及所得</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/07/二进制文件基础/">二进制文件基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/04/堆栈及汇编基础/">堆栈及汇编基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/定一个小目标/">定一个小目标</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/practice-8之PEiD插件/">practice 8之PEiD插件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/14/practice-7之行为分析/">practice 7之行为分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/13/practice-6之算法夹杂/">practice 6之算法夹杂</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/12/practice-5之万能断点/">practice 5之万能断点</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/12/practice-4之IDA用法/">practice-4之IDA用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/10/practice-3之pyo学习/">practice-3之pyo学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/10/practice-2之汇编/">practice-2之汇编</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/09/8道Pwn基础练习所得/">8道Pwn基础练习所得</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/08/一步一步学ROP之x86篇/">一步一步学ROP之x86篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/30/practice-1之图片reverse/">practice-1之图片reverse</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/16/寒假计划/">寒假计划</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/12/GDB寄存器和内存查询指令/">GDB寄存器和内存查询指令</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/gdb与peda指令学习学习笔记/">gdb与peda指令学习学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/04/hexo搭建/">hexo搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/03/Google-hacking-语法/">Google hacking 语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/03/绕过网站访问限制的方法/">绕过网站访问限制的方法</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2018 M1s5p
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
             title: "a.article-title, .article-more-link a", 
             post: ".article-entry a[href], .copyright a[href]", 
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
             articleNav: "#article-nav a, #post-nav-button a", 
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) M1s5p " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) M1s5p " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>